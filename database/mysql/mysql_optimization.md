
# MySQL优化
> optimization


---

- 提前过滤减少数据范围，然后再做复杂操作

---
- 尽量减少全表扫描，注意导致索引失效


SQL查询慢的原因
- 没有索引：`where`、`order by`、`join ... on`、`group by`后字段没有建立索引

- 索引失效
    - 字符串模糊查询支持最左前缀匹配，百分号`%`尽量在最右边
    - 有索引的字段使用了函数或表达式运算可能导致索引失效
    - 隐式类型转换

- 锁


- 在 MySQL 5.0 之前的版本要尽量避免使用 or 查询，可以使用 union 或者子查询来替代，因为早期的 MySQL 版本使用 or 查询可能会导致索引失效问题，
- 在 MySQL 5.0 之后的版本中引入了索引合并，就是多条件查询，比如 or 或 and 查询的结果集进行合并交集或并集的功能，就不会导致索引失效的问题了。

---

- 避免在`where`条件语句中使用`!=`或`<>`进行不等于判断会导致查询引擎放弃索引而进行全表扫描。

- 查询具体的字段而非全部字段，使用分页，减少不必要的数据传输占有读写

- 创表语句中要求字段非空`not null`并设置默认值，空值会导致查询过程中索引失效的问题

- 尽量使用`union all`代替`or`
- 避免使用`in`、`not in`，导致全表扫描

- MySQL通过创建并填充临时表的方式来执行`union`
- `union all`对比`union`查询多了去重操作，没有`all`关键字MySQL会给临时表加`distinct`属性
- 复杂SQL拆分为多个简单SQL，便于使用MySQL的查询缓存(Query Cache)

- 尽量使用`join`连接语句来替代子查询：因为子查询会新创建一张临时表，而临时表的创建与销毁影响性能，但join连接语句并不会创建临时表
- join表不易太多，阿里巴巴开发者手册要求不能超过3个
- 索引不能太多，阿里巴巴开发者手册要求单表索引数量不能超过5个，单个索引字段数量不能超过5个



- 尽量使用小表驱动大表的方式进行关联查询
    - in：优先执行子查询，左边大表，右边小表
    - exists：优先执行主查询，左边大小表，右边大表



- 多使用`inner join`，结果是交集，`left|right join`结果过多



---
- 模糊查询注意使用最左前缀匹配：可以定义字符串的一部分来作为索引，可以减少空间的占用和提高查询效率。



- 联合索引注意最左匹配原则：创建联合索引的时候需要注意索引字段创建的顺序，在每次复合查询条件字段时是从左往右匹配数据的

- 特别注意陷阱问题：关于联合索引注意最左匹配原则，在高版本数据库中会优化查询调整条件顺序


- 尽量使用数字型表示枚举类型，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。

## not null & ''空值

- null会影响一些聚合函数统计，`count(column)`不统计null
- B+树不存储null，索引统计不到
- `not in`子查询在有null的情况下返回结果都是空

---
---
- 网络通信
- 查询缓存
- 解析器
- 优化器：MySQL使用基于成本的优化器
```sql

show status like 'last_query_cost'

```

- 先解析SQL语句，生成对应解析树，过程中验证语法规则；预处理过程是校验合法性（例如表和列是否存在）
- 优化：调整查询条件顺序，调整表的关联顺序，
- 在完成解析和优化阶段以后，MySQL会生成对应的执行计划，查询执行引擎根据执行计划给出的指令逐步执行得出结果。

## 查询缓存



- 查询中包含自定义函数，存储过程，用户变量，临时表，系统表，其结果都不会被缓存
- 查询缓存中数据涉及的表发发生变化（包括结构和数据），都会导致该表所有相关的缓存数据失效

- 可以通过`SQL_CACHE`和`SQL_NO_CACHE`来控制某个查询语句是否使用缓存

- 写密集型应用不建议打开查询缓存，通过设置`query_cache_type=DEMAND`可以控制只有查询语句带有`SQL_CACHE`的才会使用缓存

### 数据库设计
- 使用多个小表代替一个大表，注意不要过度拆分
- 使用批量插入代替循环单条插入
- 合理设置缓存空间大小


---


## 慢查询
- 开启慢查询日志的记录功能：
1.命令行执行 mysql>
set global slow_query_log=1
2.配置文件 my.cnf
```ini
slow_query_log=1
slow_query_log_file=/tmp/mysql_slow.log
```
---

## 回表查询
---








