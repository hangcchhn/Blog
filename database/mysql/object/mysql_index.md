

# MySQL索引
> index

- 索引本质就是以空间换时间
- 索引不能全部存在在内存中，存储在磁盘上

---


---


## 索引类型


- 普通索引：index
没有任何限制，优化查询数据


- 唯一索引：unique index
列值必须唯一，允许有空值


- 主键索引:primary key
不允许值重复或者值为空



- 全文索引：fulltext
字符类型：char、varchar、text
5.7.x之前只有myisam存储引擎支持全文索引

- 空间索引：spatial
空间类型： geometry、point、linstring、polygon
5.7.x之前只有myisam存储引擎支持空间索引


- 单列索引和组合索引



---
## 新增索引方式
> 以唯一索引unique index为例
```sql
-- 创建表同时带上索引
create table t_user (
    user_id int(16) not null,
    user_name varchar(16) not null,
    primary key (user_id),
    unique key uk_user (user_id)
);



create table t_user (
    user_id int(16) not null,
    user_name varchar(16) not null,
);
-- 修改表结构添加索引
alter table t_user add unique index ui_user (user_id);

-- 给已存在的表创建索引，不能创建主键索引
create unique index ui_user on t_user (user_id)；


```




---

索引原理

- 磁盘使用磁针按磁道读取盘面扇形区域数据
- 局部性原理：预读部分濑尿虾数据到高速缓冲区（三级缓存）
- InnoDB存储引擎：一次默认会读取16KB数据到内存。

### 二叉查找树
> Binary Search Tree
- 每个结点有且仅存一个数据，所有非叶子结点至多拥有两个子结点；
- 非叶子结点存储的数据大于其左子结点数据，小于其右子结点数据；



- 平衡二叉树
1.左右子树深度之差不大于2

### 红黑树（Red-Black Tree）

- 根结点是黑色的，叶子结点是黑色的
- 红色结点的子结点必须是黑色的
- 每个结点到叶子结点的所有路径都包含相同数目的黑色结点



- B树（B-树）


- 多路搜索树


---
## B+树
- B+树对比B树主要区别在于非叶子结点是否存储数据

- B+树非叶子结点不存储数据，只存储指向叶子结点的指针，指针大小远小于数据记录，可以使非叶子结点存储更多，从而降低B+树的高度，使B+树显得更矮更胖，减少磁盘IO次数
- 每页存储更多的非叶子结点，非叶子结点拥有更多的叶子结点
- 叶子结点之间都存在一个单向指针，指向下一个结点，形成一个单向链表


- MySQL数据库InnoDB存储引擎中索引使用B+树
- MySQL优化了B+树，叶子结点之间新增一个指向上一个结点的指针，形成双向链表，提高性能

- 主键id为bigint类型长度为8字节，指针在InnoDB源码中设置为6字节，非叶子结点（主键和指针）共占14字节；
- InnoDB存储引擎的最小存储单元是页，结点容量是页大小，每页大小是16KB=16384字节，每页存储非叶子结点数量是16384/14=1170
- 计算方便大多假设类比通常情况，假设一行记录的数据大小为1KB，每页存储数据记录数量是16KB/1KB=16
- B+树大概有1170子树，高度大概是3层，就能满足千万级的数据存储，总记录数为1170*1170*16=21902400条
- 一次页操作代表一次磁盘IO操作，通过索引查询通常3次磁盘IO操作就能找到数据


---

- 聚簇索引：
    - 存在主键就以主键索引作为聚簇索引
    - 没有主键存在唯一索引，就以第一个不为null的唯一索引当作聚簇索引
    - 没有主键和唯一索引时，InnoDB会自动使用一个长度为6字节的自增字段ROWID来构建聚簇索引
- 辅助索引：除聚簇索引之外的所有索引

- 回表查询：使用辅助索引查询时，叶子结点存储的是聚簇索引，并不是完整记录，需要再次根据聚簇索引获取完整的行数据记录；可以使用组合索引包含需要的字段，此时不再需要回表查询